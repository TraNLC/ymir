<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin ‚Äî Qu·∫£n l√Ω IP truy c·∫≠p</title>
  <link rel="stylesheet" href="admin.css">
</head>
<body>
  <script>
  async function sha256(t){const e=new TextEncoder().encode(t),n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n)).map(b=>b.toString(16).padStart(2,"0")).join("")}
  async function getFingerprint(){
    const d=[navigator.userAgent,navigator.language,Intl.DateTimeFormat().resolvedOptions().timeZone,
      screen.width+'x'+screen.height,screen.colorDepth,navigator.platform].join('|');
    return await sha256(d);
  }
  const AUTH_API='https://ymir-auth.tranlc-ymir.workers.dev';
  // Check authentication and redirect if needed
  async function requireAuth(){
    try{
      const fp=await getFingerprint();
      const tok=localStorage.getItem('ymir_token');
      if(!tok){
        window.location.href='login.html';
        return;
      }
      const r=await fetch(`${AUTH_API}/verify?fp=${fp}`,{headers:{authorization:`Bearer ${tok}`}}).then(x=>x.json());
      if(r&&r.ok){
        if(r.user!=='admin'){
          window.location.href='user.html';
          return;
        }
        return;
      }else{
        localStorage.removeItem('ymir_token');
        window.location.href='login.html';
      }
    }catch{
      window.location.href='login.html';
    }
  }
  requireAuth();

  // Force remove any background watermark that might remain
  try { document.addEventListener('DOMContentLoaded', function(){ document.body.style.backgroundImage = 'none'; }); } catch(_){}

  // ---- Admin panel helpers ----
  const API_BASE = AUTH_API;
  function getAdminToken(){
    const inp = document.getElementById('adm-token');
    const v = (inp && inp.value ? inp.value.trim() : '');
    return v || (localStorage.getItem('ymir_admin_token')||'').trim();
  }
  function setAdminMsg(msg, ok){ 
    const el=document.getElementById('adm-msg'); 
    if(el){ 
      el.style.display = 'block';
      el.style.color = ok? '#10b981' : '#f87171'; 
      el.style.background = ok? 'rgba(16,185,129,0.1)' : 'rgba(248,113,113,0.1)';
      el.style.border = `1px solid ${ok? '#10b981' : '#f87171'}`;
      el.textContent = msg; 
      if(ok) setTimeout(()=>{ el.style.display = 'none'; }, 3000);
    } 
  }
  
  // Load table v·ªõi danh s√°ch users v√† IPs
  async function adminLoadTable(){
    const token = getAdminToken();
    if(!token) return setAdminMsg('Nh·∫≠p Admin Token tr∆∞·ªõc', false);
    try{
      const res = await fetch(`${API_BASE}/admin/users/list`, { headers: {'x-admin-token': token} });
      if(!res.ok) return setAdminMsg('L·ªói: ' + res.status, false);
      const data = await res.json();
      renderAdminTable(data.users || []);
      setAdminMsg(`ƒê√£ t·∫£i ${data.users?.length || 0} user(s)`, true);
    }catch(e){
      setAdminMsg('L·ªói: ' + e.message, false);
    }
  }

  // Load danh s√°ch IP ch·ªù duy·ªát
  async function adminLoadPending(){
    const token = getAdminToken();
    const tbody = document.getElementById('pending-tbody');
    if(!tbody) return;
    if(!token){ tbody.innerHTML = '<tr><td colspan="3" class="empty-state">Nh·∫≠p Admin Token tr∆∞·ªõc</td></tr>'; return; }
    try{
      const res = await fetch(`${API_BASE}/admin/pending/list`, { headers: {'x-admin-token': token} });
      if(!res.ok){ tbody.innerHTML = `<tr><td colspan="3" class=\"empty-state\">L·ªói: ${res.status}</td></tr>`; return; }
      const data = await res.json();
      renderPendingTable(data.pending || []);
    }catch(e){
      const tbody2 = document.getElementById('pending-tbody');
      if(tbody2) tbody2.innerHTML = `<tr><td colspan="3" class=\"empty-state\">L·ªói: ${e.message}</td></tr>`;
    }
  }

  function adminLoadAll(){
    const inp = document.getElementById('adm-token');
    if (inp) localStorage.setItem('ymir_admin_token', (inp.value||'').trim());
    adminLoadTable();
    adminLoadPending();
  }

  // T·ª± ƒë·ªông n·∫°p token ƒë√£ l∆∞u v√† t·∫£i danh s√°ch khi v√†o trang
  document.addEventListener('DOMContentLoaded', function(){
    const inp = document.getElementById('adm-token');
    const saved = localStorage.getItem('ymir_admin_token') || '';
    if (inp && saved && !inp.value) inp.value = saved;
    if (saved) { adminLoadAll(); }
  });

  // Load danh s√°ch IP ƒëang ch·ªù duy·ªát
  async function adminLoadPending(){
    const token = getAdminToken();
    if(!token) return;
    try{
      const res = await fetch(`${API_BASE}/admin/pending/list`, { headers: {'x-admin-token': token} });
      if(!res.ok) return;
      const data = await res.json();
      renderPendingTable(data.pending || []);
    }catch(_){ }
  }

  // Auto save token and auto load on page ready
  document.addEventListener('DOMContentLoaded', function(){
    const inp = document.getElementById('adm-token');
    const saved = localStorage.getItem('ymir_admin_token') || '';
    if (inp) {
      if (saved && !inp.value) inp.value = saved;
      inp.addEventListener('input', function(){
        localStorage.setItem('ymir_admin_token', (inp.value||'').trim());
      });
      inp.addEventListener('keydown', function(e){ if(e.key==='Enter'){ adminLoadTable(); }});
    }
    // Auto load once
    adminLoadTable();
    adminLoadPending();
  });
  
  // Render b·∫£ng admin
  function renderAdminTable(users){
    const tbody = document.getElementById('admin-ip-tbody');
    if(!tbody) return;
    if(users.length === 0){
      tbody.innerHTML = '<tr><td colspan="3" class="empty-state">Ch∆∞a c√≥ user n√†o. Th√™m user ƒë·ªÉ b·∫Øt ƒë·∫ßu qu·∫£n l√Ω IP.</td></tr>';
      return;
    }
    tbody.innerHTML = users.map(u => {
      const ips = u.ips || [];
      const ipList = ips.length > 0 ? ips.map(ip => `
        <span class="ip-tag">
          ${ip}
          <button onclick="adminRemoveIpFromUser('${u.username}', '${ip}')">√ó</button>
        </span>
      `).join('') : '<span style="color: #94a3b8;">Ch∆∞a c√≥ IP</span>';
      return `
        <tr>
          <td style="font-weight: 600;">${u.username}</td>
          <td>${ipList}</td>
          <td>
            <div class="ip-input-group">
              <input type="text" id="ip-input-${u.username}" placeholder="Nh·∫≠p IP">
              <button onclick="adminAddIpToUser('${u.username}')">+ Th√™m IP</button>
              <button onclick="adminGetMyIpForUser('${u.username}')" title="L·∫•y IP hi·ªán t·∫°i">IP</button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  function renderPendingTable(pending){
    const tbody = document.getElementById('pending-tbody');
    if(!tbody) return;
    if(!pending.length){
      tbody.innerHTML = '<tr><td colspan="3" class="empty-state">Ch∆∞a c√≥ y√™u c·∫ßu duy·ªát IP</td></tr>';
      return;
    }
    tbody.innerHTML = pending.map(item => {
      const ipTags = (item.ips||[]).map(ip => `<span class=\"ip-tag\">${ip}</span>`).join('');
      const actions = (item.ips||[]).map(ip => `<button class=\"btn-primary\" onclick=\"adminApprovePending('${item.username}','${ip}')\">Duy·ªát ${ip}</button>`).join(' ');
      return `
        <tr>
          <td style=\"font-weight: 600;\">${item.username}</td>
          <td>${ipTags}</td>
          <td>${actions}</td>
        </tr>
      `;
    }).join('');
  }

  async function adminApprovePending(username, ip){
    const token = getAdminToken();
    if(!token) return setAdminMsg('Nh·∫≠p Admin Token tr∆∞·ªõc', false);
    try{
      const res = await fetch(`${API_BASE}/admin/pending/approve`, {
        method: 'POST',
        headers: { 'content-type': 'application/json', 'x-admin-token': token },
        body: JSON.stringify({ username, ip })
      });
      if(res.ok){
        setAdminMsg(`ƒê√£ duy·ªát IP ${ip} cho ${username}`, true);
        adminLoadTable();
        adminLoadPending();
      } else {
        setAdminMsg('Duy·ªát th·∫•t b·∫°i', false);
      }
    }catch(e){
      setAdminMsg('L·ªói: ' + e.message, false);
    }
  }
  
  // Th√™m user v√†o danh s√°ch qu·∫£n l√Ω
  async function adminAddUser(){
    const token = getAdminToken();
    const username = document.getElementById('adm-new-username').value.trim();
    if(!token) return setAdminMsg('Nh·∫≠p Admin Token tr∆∞·ªõc', false);
    if(!username) return setAdminMsg('Nh·∫≠p username', false);
    try{
      const res = await fetch(`${API_BASE}/admin/users/add`, { 
        method: 'POST', 
        headers: {'content-type': 'application/json', 'x-admin-token': token}, 
        body: JSON.stringify({ username }) 
      });
      const j = await res.json().catch(()=>({}));
      if(res.ok){
        setAdminMsg(`ƒê√£ th√™m user "${username}"`, true);
        document.getElementById('adm-new-username').value = '';
        adminLoadTable();
      }else{
        setAdminMsg('L·ªói: ' + (j.error || res.status), false);
      }
    }catch(e){
      setAdminMsg('L·ªói: ' + e.message, false);
    }
  }
  
  // Th√™m IP cho user
  async function adminAddIpToUser(username){
    const token = getAdminToken();
    const ipInput = document.getElementById(`ip-input-${username}`);
    const ip = ipInput?.value.trim();
    if(!token) return setAdminMsg('Nh·∫≠p Admin Token tr∆∞·ªõc', false);
    if(!ip) return setAdminMsg('Nh·∫≠p IP', false);
    try{
      const res = await fetch(`${API_BASE}/admin/allowip/add`, { 
        method: 'POST', 
        headers: {'content-type': 'application/json', 'x-admin-token': token}, 
        body: JSON.stringify({ username, ip }) 
      });
      const j = await res.json().catch(()=>({}));
      if(res.ok){
        setAdminMsg(`ƒê√£ th√™m IP ${ip} cho ${username}`, true);
        ipInput.value = '';
        adminLoadTable();
      }else{
        setAdminMsg('L·ªói: ' + (j.error || res.status), false);
      }
    }catch(e){
      setAdminMsg('L·ªói: ' + e.message, false);
    }
  }
  
  // X√≥a IP c·ªßa user
  async function adminRemoveIpFromUser(username, ip){
    const token = getAdminToken();
    if(!token) return setAdminMsg('Nh·∫≠p Admin Token tr∆∞·ªõc', false);
    if(!confirm(`X√≥a IP ${ip} c·ªßa user ${username}?`)) return;
    try{
      const res = await fetch(`${API_BASE}/admin/allowip/remove`, { 
        method: 'POST', 
        headers: {'content-type': 'application/json', 'x-admin-token': token}, 
        body: JSON.stringify({ username, ip }) 
      });
      const j = await res.json().catch(()=>({}));
      if(res.ok){
        setAdminMsg(`ƒê√£ x√≥a IP ${ip}`, true);
        adminLoadTable();
      }else{
        setAdminMsg('L·ªói: ' + (j.error || res.status), false);
      }
    }catch(e){
      setAdminMsg('L·ªói: ' + e.message, false);
    }
  }
  
  // L·∫•y IP hi·ªán t·∫°i v√† ƒëi·ªÅn v√†o input
  async function adminGetMyIpForUser(username){
    try{
      const ip = await fetch('https://api.ipify.org').then(r=>r.text());
      const ipInput = document.getElementById(`ip-input-${username}`);
      if(ipInput) ipInput.value = ip;
      setAdminMsg(`ƒê√£ l·∫•y IP: ${ip}`, true);
    }catch{
      setAdminMsg('Kh√¥ng l·∫•y ƒë∆∞·ª£c IP', false);
    }
  }
  </script>

  <div class="admin-header">
    <h1>üîê Admin ‚Äî Qu·∫£n l√Ω IP truy c·∫≠p</h1>
  </div>

  <div class="container">
    <div id="admin-panel" class="card">
      <h2>Qu·∫£n l√Ω Users & IPs</h2>
      <p style="margin-bottom: 20px;">Qu·∫£n l√Ω IP ƒë∆∞·ª£c ph√©p theo t·ª´ng t√†i kho·∫£n. API: <code>ymir-auth.tranlc-ymir.workers.dev</code></p>
      
      <!-- Admin Token Input -->
      <div class="admin-section">
        <label>Admin Token</label>
        <div class="input-group">
          <input id="adm-token" type="password" placeholder="Nh·∫≠p ADMIN_TOKEN">
          <button class="btn-primary" onclick="adminLoadAll()">T·∫£i danh s√°ch</button>
        </div>
      </div>

      <!-- Add User Form -->
      <div class="admin-section">
        <h3>‚ûï Th√™m user v√†o danh s√°ch qu·∫£n l√Ω</h3>
        <div class="input-group">
          <input id="adm-new-username" placeholder="Username (v√≠ d·ª•: demo)">
          <button class="btn-primary" onclick="adminAddUser()">Th√™m user</button>
        </div>
      </div>

      <!-- IP Management Table -->
      <div class="table-wrapper">
        <table id="admin-ip-table">
          <thead>
            <tr>
              <th>Username</th>
              <th>Danh s√°ch IP</th>
              <th>Thao t√°c</th>
            </tr>
          </thead>
          <tbody id="admin-ip-tbody">
            <tr>
              <td colspan="3" class="empty-state">Nh·∫•n "T·∫£i danh s√°ch" ƒë·ªÉ xem users v√† IP</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="adm-msg" class="admin-message"></div>
    </div>

    <!-- Pending IPs -->
    <div class="card" style="margin-top:16px;">
      <h2>üïë IP ch·ªù duy·ªát</h2>
      <div class="table-wrapper">
        <table id="pending-table">
          <thead>
            <tr>
              <th>Username</th>
              <th>IP ch·ªù duy·ªát</th>
              <th>Thao t√°c</th>
            </tr>
          </thead>
          <tbody id="pending-tbody">
            <tr>
              <td colspan="3" class="empty-state">Ch∆∞a c√≥ y√™u c·∫ßu duy·ªát IP</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</body>
</html>

