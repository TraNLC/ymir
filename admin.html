<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin â€” Quáº£n lÃ½ IP truy cáº­p</title>
  <link rel="stylesheet" href="admin.css">
</head>
<body>
  <script>
  async function sha256(t){const e=new TextEncoder().encode(t),n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n)).map(b=>b.toString(16).padStart(2,"0")).join("")}
  async function getFingerprint(){
    const d=[navigator.userAgent,navigator.language,Intl.DateTimeFormat().resolvedOptions().timeZone,
      screen.width+'x'+screen.height,screen.colorDepth,navigator.platform].join('|');
    return await sha256(d);
  }
  const AUTH_API='https://ymir-auth.tranlc-ymir.workers.dev';
  // Check authentication and redirect if needed
  async function requireAuth(){
    try{
      const fp=await getFingerprint();
      const tok=localStorage.getItem('ymir_token');
      if(!tok){
        window.location.href='login.html';
        return;
      }
      const r=await fetch(`${AUTH_API}/verify?fp=${fp}`,{headers:{authorization:`Bearer ${tok}`}}).then(x=>x.json());
      if(r&&r.ok){
        if(r.user!=='admin'){
          window.location.href='user.html';
          return;
        }
        return;
      }else{
        localStorage.removeItem('ymir_token');
        window.location.href='login.html';
      }
    }catch{
      window.location.href='login.html';
    }
  }
  requireAuth();

  // ---- Admin panel helpers ----
  const API_BASE = AUTH_API;
  function getAdminToken(){ return document.getElementById('adm-token').value.trim(); }
  function setAdminMsg(msg, ok){ 
    const el=document.getElementById('adm-msg'); 
    if(el){ 
      el.style.display = 'block';
      el.style.color = ok? '#10b981' : '#f87171'; 
      el.style.background = ok? 'rgba(16,185,129,0.1)' : 'rgba(248,113,113,0.1)';
      el.style.border = `1px solid ${ok? '#10b981' : '#f87171'}`;
      el.textContent = msg; 
      if(ok) setTimeout(()=>{ el.style.display = 'none'; }, 3000);
    } 
  }
  
  // Load table vá»›i danh sÃ¡ch users vÃ  IPs
  async function adminLoadTable(){
    const token = getAdminToken();
    if(!token) return setAdminMsg('Nháº­p Admin Token trÆ°á»›c', false);
    try{
      const res = await fetch(`${API_BASE}/admin/users/list`, { headers: {'x-admin-token': token} });
      if(!res.ok) return setAdminMsg('Lá»—i: ' + res.status, false);
      const data = await res.json();
      renderAdminTable(data.users || []);
      setAdminMsg(`ÄÃ£ táº£i ${data.users?.length || 0} user(s)`, true);
    }catch(e){
      setAdminMsg('Lá»—i: ' + e.message, false);
    }
  }
  
  // Render báº£ng admin
  function renderAdminTable(users){
    const tbody = document.getElementById('admin-ip-tbody');
    if(!tbody) return;
    if(users.length === 0){
      tbody.innerHTML = '<tr><td colspan="3" class="empty-state">ChÆ°a cÃ³ user nÃ o. ThÃªm user Ä‘á»ƒ báº¯t Ä‘áº§u quáº£n lÃ½ IP.</td></tr>';
      return;
    }
    tbody.innerHTML = users.map(u => {
      const ips = u.ips || [];
      const ipList = ips.length > 0 ? ips.map(ip => `
        <span class="ip-tag">
          ${ip}
          <button onclick="adminRemoveIpFromUser('${u.username}', '${ip}')">Ã—</button>
        </span>
      `).join('') : '<span style="color: #94a3b8;">ChÆ°a cÃ³ IP</span>';
      return `
        <tr>
          <td style="font-weight: 600;">${u.username}</td>
          <td>${ipList}</td>
          <td>
            <div class="ip-input-group">
              <input type="text" id="ip-input-${u.username}" placeholder="Nháº­p IP">
              <button onclick="adminAddIpToUser('${u.username}')">+ ThÃªm IP</button>
              <button onclick="adminGetMyIpForUser('${u.username}')" title="Láº¥y IP hiá»‡n táº¡i">IP</button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }
  
  // ThÃªm user vÃ o danh sÃ¡ch quáº£n lÃ½
  async function adminAddUser(){
    const token = getAdminToken();
    const username = document.getElementById('adm-new-username').value.trim();
    if(!token) return setAdminMsg('Nháº­p Admin Token trÆ°á»›c', false);
    if(!username) return setAdminMsg('Nháº­p username', false);
    try{
      const res = await fetch(`${API_BASE}/admin/users/add`, { 
        method: 'POST', 
        headers: {'content-type': 'application/json', 'x-admin-token': token}, 
        body: JSON.stringify({ username }) 
      });
      const j = await res.json().catch(()=>({}));
      if(res.ok){
        setAdminMsg(`ÄÃ£ thÃªm user "${username}"`, true);
        document.getElementById('adm-new-username').value = '';
        adminLoadTable();
      }else{
        setAdminMsg('Lá»—i: ' + (j.error || res.status), false);
      }
    }catch(e){
      setAdminMsg('Lá»—i: ' + e.message, false);
    }
  }
  
  // ThÃªm IP cho user
  async function adminAddIpToUser(username){
    const token = getAdminToken();
    const ipInput = document.getElementById(`ip-input-${username}`);
    const ip = ipInput?.value.trim();
    if(!token) return setAdminMsg('Nháº­p Admin Token trÆ°á»›c', false);
    if(!ip) return setAdminMsg('Nháº­p IP', false);
    try{
      const res = await fetch(`${API_BASE}/admin/allowip/add`, { 
        method: 'POST', 
        headers: {'content-type': 'application/json', 'x-admin-token': token}, 
        body: JSON.stringify({ username, ip }) 
      });
      const j = await res.json().catch(()=>({}));
      if(res.ok){
        setAdminMsg(`ÄÃ£ thÃªm IP ${ip} cho ${username}`, true);
        ipInput.value = '';
        adminLoadTable();
      }else{
        setAdminMsg('Lá»—i: ' + (j.error || res.status), false);
      }
    }catch(e){
      setAdminMsg('Lá»—i: ' + e.message, false);
    }
  }
  
  // XÃ³a IP cá»§a user
  async function adminRemoveIpFromUser(username, ip){
    const token = getAdminToken();
    if(!token) return setAdminMsg('Nháº­p Admin Token trÆ°á»›c', false);
    if(!confirm(`XÃ³a IP ${ip} cá»§a user ${username}?`)) return;
    try{
      const res = await fetch(`${API_BASE}/admin/allowip/remove`, { 
        method: 'POST', 
        headers: {'content-type': 'application/json', 'x-admin-token': token}, 
        body: JSON.stringify({ username, ip }) 
      });
      const j = await res.json().catch(()=>({}));
      if(res.ok){
        setAdminMsg(`ÄÃ£ xÃ³a IP ${ip}`, true);
        adminLoadTable();
      }else{
        setAdminMsg('Lá»—i: ' + (j.error || res.status), false);
      }
    }catch(e){
      setAdminMsg('Lá»—i: ' + e.message, false);
    }
  }
  
  // Láº¥y IP hiá»‡n táº¡i vÃ  Ä‘iá»n vÃ o input
  async function adminGetMyIpForUser(username){
    try{
      const ip = await fetch('https://api.ipify.org').then(r=>r.text());
      const ipInput = document.getElementById(`ip-input-${username}`);
      if(ipInput) ipInput.value = ip;
      setAdminMsg(`ÄÃ£ láº¥y IP: ${ip}`, true);
    }catch{
      setAdminMsg('KhÃ´ng láº¥y Ä‘Æ°á»£c IP', false);
    }
  }
  </script>

  <div class="admin-header">
    <h1>ğŸ” Admin â€” Quáº£n lÃ½ IP truy cáº­p</h1>
  </div>

  <div class="container">
    <div id="admin-panel" class="card">
      <h2>Quáº£n lÃ½ Users & IPs</h2>
      <p style="margin-bottom: 20px;">Quáº£n lÃ½ IP Ä‘Æ°á»£c phÃ©p theo tá»«ng tÃ i khoáº£n. API: <code>ymir-auth.tranlc-ymir.workers.dev</code></p>
      
      <!-- Admin Token Input -->
      <div class="admin-section">
        <label>Admin Token</label>
        <div class="input-group">
          <input id="adm-token" type="password" placeholder="Nháº­p ADMIN_TOKEN">
          <button class="btn-primary" onclick="adminLoadTable()">Táº£i danh sÃ¡ch</button>
        </div>
      </div>

      <!-- Add User Form -->
      <div class="admin-section">
        <h3>â• ThÃªm user vÃ o danh sÃ¡ch quáº£n lÃ½</h3>
        <div class="input-group">
          <input id="adm-new-username" placeholder="Username (vÃ­ dá»¥: demo)">
          <button class="btn-primary" onclick="adminAddUser()">ThÃªm user</button>
        </div>
      </div>

      <!-- IP Management Table -->
      <div class="table-wrapper">
        <table id="admin-ip-table">
          <thead>
            <tr>
              <th>Username</th>
              <th>Danh sÃ¡ch IP</th>
              <th>Thao tÃ¡c</th>
            </tr>
          </thead>
          <tbody id="admin-ip-tbody">
            <tr>
              <td colspan="3" class="empty-state">Nháº¥n "Táº£i danh sÃ¡ch" Ä‘á»ƒ xem users vÃ  IP</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="adm-msg" class="admin-message"></div>
    </div>
  </div>
</body>
</html>

