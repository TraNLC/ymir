<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin ‚Äî Qu·∫£n l√Ω IP truy c·∫≠p</title>
  <link rel="stylesheet" href="admin.css">
</head>
<body>
  <script>
  async function sha256(t){const e=new TextEncoder().encode(t),n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n)).map(b=>b.toString(16).padStart(2,"0")).join("")}
  async function getFingerprint(){
    const d=[navigator.userAgent,navigator.language,Intl.DateTimeFormat().resolvedOptions().timeZone,
      screen.width+'x'+screen.height,screen.colorDepth,navigator.platform].join('|');
    return await sha256(d);
  }
  const AUTH_API='https://ymir-auth.tranlc-ymir.workers.dev';
  // Check authentication and redirect if needed
  async function requireAuth(){
    try{
      const fp=await getFingerprint();
      const tok=localStorage.getItem('ymir_token');
      if(!tok){
        window.location.href='login.html';
        return;
      }
      const r=await fetch(`${AUTH_API}/verify?fp=${fp}`,{headers:{authorization:`Bearer ${tok}`}}).then(x=>x.json());
      if(r&&r.ok){
        if(r.user!=='admin'){
          window.location.href='user.html';
          return;
        }
        return;
      }else{
        localStorage.removeItem('ymir_token');
        window.location.href='login.html';
      }
    }catch{
      window.location.href='login.html';
    }
  }
  requireAuth();

  // Force remove any background watermark that might remain
  try { document.addEventListener('DOMContentLoaded', function(){ document.body.style.backgroundImage = 'none'; }); } catch(_){}

  // ---- Admin panel helpers ----
  const API_BASE = AUTH_API;
  function getBearer(){ return localStorage.getItem('ymir_token') || ''; }
  // lightweight debug logger rendered on the page
  const __logs = [];
  function addLog(label, payload){
    try{
      const ts = new Date().toISOString();
      const entry = `[${ts}] ${label} ` + (payload!==undefined? (typeof payload==='string'? payload : JSON.stringify(payload)) : '');
      __logs.unshift(entry);
      const pre = document.getElementById('debug-pre');
      if(pre){ pre.textContent = __logs.slice(0,200).join("\n\n"); }
    }catch(_){ /* ignore */ }
  }
  function setAdminMsg(msg, ok){ 
    const el=document.getElementById('adm-msg'); 
    if(el){ 
      el.style.display = 'block';
      el.style.color = ok? '#10b981' : '#f87171'; 
      el.style.background = ok? 'rgba(16,185,129,0.1)' : 'rgba(248,113,113,0.1)';
      el.style.border = `1px solid ${ok? '#10b981' : '#f87171'}`;
      el.textContent = msg; 
      if(ok) setTimeout(()=>{ el.style.display = 'none'; }, 3000);
    } 
  }
  
// Load table v·ªõi danh s√°ch users v√† IPs (∆∞u ti√™n /admin/users/all ƒë·ªÉ l·∫•y c·∫£ password)
  async function adminLoadTable(){
    const token = getBearer();
    if(!token) return setAdminMsg('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p admin', false);
    try{
      addLog('REQUEST /admin/users/all');
      let res = await fetch(`${API_BASE}/admin/users/all`, { headers: { authorization: `Bearer ${token}` } });
      let text = await res.text();
      addLog('RESPONSE /admin/users/all', `status ${res.status}: ${text}`);
      let data = {};
      try{ data = JSON.parse(text); }catch(_){ data = {}; }
      if(!res.ok || !data.users){
        // fallback to older endpoint
        addLog('FALLBACK /admin/users/list');
        res = await fetch(`${API_BASE}/admin/users/list`, { headers: { authorization: `Bearer ${token}` } });
        text = await res.text();
        addLog('RESPONSE /admin/users/list', `status ${res.status}: ${text}`);
        try{ data = JSON.parse(text); }catch(_){ data = {}; }
      }
      renderAdminTable(data.users || []);
      setAdminMsg(`ƒê√£ t·∫£i ${data.users?.length || 0} user(s)`, true);
    }catch(e){
      setAdminMsg('L·ªói: ' + e.message, false);
      addLog('ERROR adminLoadTable', e.message);
    }
  }

  // Load danh s√°ch IP ch·ªù duy·ªát
  async function adminLoadPending(){
    const token = getBearer();
    const tbody = document.getElementById('pending-tbody');
    if(!tbody) return;
    if(!token){ tbody.innerHTML = '<tr><td colspan="3" class="empty-state">B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p admin</td></tr>'; return; }
    try{
      const res = await fetch(`${API_BASE}/admin/pending/list`, { headers: { authorization: `Bearer ${token}` } });
      if(!res.ok){ tbody.innerHTML = `<tr><td colspan="3" class=\"empty-state\">L·ªói: ${res.status}</td></tr>`; return; }
      const data = await res.json();
      renderPendingTable(data.pending || []);
    }catch(e){
      const tbody2 = document.getElementById('pending-tbody');
      if(tbody2) tbody2.innerHTML = `<tr><td colspan="3" class=\"empty-state\">L·ªói: ${e.message}</td></tr>`;
    }
  }

  function adminLoadAll(){
    adminLoadTable();
  }

  // T·ª± ƒë·ªông n·∫°p token ƒë√£ l∆∞u v√† t·∫£i danh s√°ch khi v√†o trang
  document.addEventListener('DOMContentLoaded', function(){ adminLoadAll(); });

// (Removed legacy admin-token handlers)
  
  // Render b·∫£ng admin
  function renderAdminTable(users){
    const tbody = document.getElementById('admin-ip-tbody');
    if(!tbody) return;
    if(users.length === 0){
      tbody.innerHTML = '<tr><td colspan="3" class="empty-state">Ch∆∞a c√≥ user n√†o.</td></tr>';
      return;
    }
    tbody.innerHTML = users.map(u => {
      const password = (u.password!==undefined && u.password!==null)? String(u.password) : '';
      const status = (u.activeSessions>0) ? '<span style="color:#10b981">Online</span>' : (u.deviceBound ? '<span style=\"color:#10b981\">ƒê√£ login</span>' : '<span style=\"color:#94a3b8\">Ch∆∞a login</span>');
      const last = (u.lastLoginAt ? new Date(u.lastLoginAt).toLocaleString() : '-') + (u.lastLoginIp? `\\n${u.lastLoginIp}` : '');
      return `
        <tr>
          <td>
            <input type="text" id="uname-${u.username}" value="${u.username.replace(/"/g,'&quot;')}" style="width:180px;">
          </td>
          <td>
            <input type="text" id="pwd-${u.username}" value="${password.replace(/"/g,'&quot;')}" placeholder="(nh·∫≠p ƒë·ªÉ ƒë·ªïi)" style="width:180px;">
          </td>
          <td>${status}</td>
          <td><pre style="margin:0;white-space:pre-wrap;color:#94a3b8">${last}</pre></td>
          <td>
            <button class="btn-primary" onclick="adminSaveUser('${u.username}')">L∆∞u</button>
            <button style="margin-left:6px" onclick="adminLogoutAll('${u.username}')">ƒêƒÉng xu·∫•t t·∫•t c·∫£</button>
            <button style="margin-left:6px" onclick="adminUnbind('${u.username}')">G·ª° kh√≥a thi·∫øt b·ªã</button>
            <button style="margin-left:6px;color:#f87171;border-color:#f87171" onclick="adminDeleteUser('${u.username}')">X√≥a</button>
          </td>
        </tr>
      `;
    }).join('');
  }

  function renderPendingTable(pending){
    const tbody = document.getElementById('pending-tbody');
    if(!tbody) return;
    if(!pending.length){
      tbody.innerHTML = '<tr><td colspan="3" class="empty-state">Ch∆∞a c√≥ y√™u c·∫ßu duy·ªát IP</td></tr>';
      return;
    }
    tbody.innerHTML = pending.map(item => {
      const ipTags = (item.ips||[]).map(ip => `<span class=\"ip-tag\">${ip}</span>`).join('');
      const actions = (item.ips||[]).map(ip => `<button class=\"btn-primary\" onclick=\"adminApprovePending('${item.username}','${ip}')\">Duy·ªát ${ip}</button>`).join(' ');
      return `
        <tr>
          <td style=\"font-weight: 600;\">${item.username}</td>
          <td>${ipTags}</td>
          <td>${actions}</td>
        </tr>
      `;
    }).join('');
  }

  async function adminApprovePending(username, ip){
    const token = getBearer();
    if(!token) return setAdminMsg('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p admin', false);
    try{
      const res = await fetch(`${API_BASE}/admin/pending/approve`, {
        method: 'POST',
        headers: { 'content-type': 'application/json', authorization: `Bearer ${token}` },
        body: JSON.stringify({ username, ip })
      });
      if(res.ok){
        setAdminMsg(`ƒê√£ duy·ªát IP ${ip} cho ${username}`, true);
        adminLoadTable();
        adminLoadPending();
      } else {
        const t = await res.text();
        setAdminMsg('Duy·ªát th·∫•t b·∫°i: ' + (t||res.status), false);
        addLog('pending/approve failed', t||res.status);
      }
    }catch(e){
      setAdminMsg('L·ªói: ' + e.message, false);
      addLog('ERROR adminApprovePending', e.message);
    }
  }
  
  // Th√™m user v√†o danh s√°ch qu·∫£n l√Ω
  async function adminAddUser(){
    const token = getBearer();
    const username = (document.getElementById('adm-new-username').value||'').trim();
    const password = (document.getElementById('adm-new-password')?.value||'').trim();
    if(!token) return setAdminMsg('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p admin', false);
    if(!username || !password) return setAdminMsg('Nh·∫≠p username v√† password', false);
    try{
      addLog('REQUEST /admin/users/create', {username});
      const res = await fetch(`${API_BASE}/admin/users/create`, { 
        method: 'POST', 
        headers: {'content-type': 'application/json', authorization: `Bearer ${token}`}, 
        body: JSON.stringify({ username, password }) 
      });
      const raw = await res.text();
      addLog('RESPONSE /admin/users/create', `status ${res.status}: ${raw}`);
      const j = (()=>{ try{return JSON.parse(raw);}catch(_){return {};}})();
      if(res.ok){
        setAdminMsg(`ƒê√£ t·∫°o user "${username}"`, true);
        document.getElementById('adm-new-username').value = '';
        if(document.getElementById('adm-new-password')) document.getElementById('adm-new-password').value = '';
        adminLoadTable();
      }else{
        setAdminMsg('L·ªói: ' + (j.error || raw || res.status), false);
      }
    }catch(e){
      setAdminMsg('L·ªói: ' + e.message, false);
      addLog('ERROR adminAddUser', e.message);
    }
  }
  
  // Th√™m IP cho user
  async function adminAddIpToUser(username){
    const token = getBearer();
    const ipInput = document.getElementById(`ip-input-${username}`);
    const ip = ipInput?.value.trim();
    if(!token) return setAdminMsg('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p admin', false);
    if(!ip) return setAdminMsg('Nh·∫≠p IP', false);
    try{
      addLog('REQUEST /admin/allowip/add', {username, ip});
      const res = await fetch(`${API_BASE}/admin/allowip/add`, { 
        method: 'POST', 
        headers: {'content-type': 'application/json', authorization: `Bearer ${token}`}, 
        body: JSON.stringify({ username, ip }) 
      });
      const raw = await res.text();
      addLog('RESPONSE /admin/allowip/add', `status ${res.status}: ${raw}`);
      const j = (()=>{ try{return JSON.parse(raw);}catch(_){return {};}})();
      if(res.ok){
        setAdminMsg(`ƒê√£ th√™m IP ${ip} cho ${username}`, true);
        ipInput.value = '';
        adminLoadTable();
      }else{
        setAdminMsg('L·ªói: ' + (j.error || raw || res.status), false);
      }
    }catch(e){
      setAdminMsg('L·ªói: ' + e.message, false);
      addLog('ERROR adminAddIpToUser', e.message);
    }
  }
  
  // X√≥a IP c·ªßa user
  async function adminRemoveIpFromUser(username, ip){
    const token = getBearer();
    if(!token) return setAdminMsg('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p admin', false);
    if(!confirm(`X√≥a IP ${ip} c·ªßa user ${username}?`)) return;
    try{
      addLog('REQUEST /admin/allowip/remove', {username, ip});
      const res = await fetch(`${API_BASE}/admin/allowip/remove`, { 
        method: 'POST', 
        headers: {'content-type': 'application/json', authorization: `Bearer ${token}`}, 
        body: JSON.stringify({ username, ip }) 
      });
      const raw = await res.text();
      addLog('RESPONSE /admin/allowip/remove', `status ${res.status}: ${raw}`);
      const j = (()=>{ try{return JSON.parse(raw);}catch(_){return {};}})();
      if(res.ok){
        setAdminMsg(`ƒê√£ x√≥a IP ${ip}`, true);
        adminLoadTable();
      }else{
        setAdminMsg('L·ªói: ' + (j.error || raw || res.status), false);
      }
    }catch(e){
      setAdminMsg('L·ªói: ' + e.message, false);
      addLog('ERROR adminRemoveIpFromUser', e.message);
    }
  }
  
  // L·∫•y IP hi·ªán t·∫°i v√† ƒëi·ªÅn v√†o input
  async function adminGetMyIpForUser(username){
    try{
      const ip = await fetch('https://api.ipify.org').then(r=>r.text());
      const ipInput = document.getElementById(`ip-input-${username}`);
      if(ipInput) ipInput.value = ip;
      setAdminMsg(`ƒê√£ l·∫•y IP: ${ip}`, true);
      addLog('INFO my IP', ip);
    }catch{
      setAdminMsg('Kh√¥ng l·∫•y ƒë∆∞·ª£c IP', false);
    }
  }

  // Update password for a user
  async function adminUpdatePassword(username){
    const token = getBearer();
    if(!token) return setAdminMsg('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p admin', false);
    const input = document.getElementById(`pwd-${username}`);
    const password = (input?.value||'').trim();
    if(!password) return setAdminMsg('Nh·∫≠p password m·ªõi', false);
    try{
      addLog('REQUEST /admin/users/update', {username});
      const res = await fetch(`${API_BASE}/admin/users/update`, {
        method: 'POST',
        headers: {'content-type':'application/json', authorization:`Bearer ${token}`},
        body: JSON.stringify({ username, password })
      });
      const raw = await res.text();
      addLog('RESPONSE /admin/users/update', `status ${res.status}: ${raw}`);
      if(res.ok){ setAdminMsg('ƒê√£ c·∫≠p nh·∫≠t m·∫≠t kh·∫©u', true); }
      else { setAdminMsg('C·∫≠p nh·∫≠t th·∫•t b·∫°i: ' + (raw||res.status), false); }
    }catch(e){
      setAdminMsg('L·ªói: ' + e.message, false);
      addLog('ERROR adminUpdatePassword', e.message);
    }
  }
  
  // Save (update password or rename user)
  async function adminSaveUser(oldUsername){
    const token = getBearer();
    if(!token) return setAdminMsg('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p admin', false);
    const newUsername = (document.getElementById(`uname-${oldUsername}`)?.value||'').trim();
    const newPassword = (document.getElementById(`pwd-${oldUsername}`)?.value||'').trim();
    if(!newUsername) return setAdminMsg('Nh·∫≠p Username', false);
    try{
      if(newUsername !== oldUsername){
        if(!newPassword) return setAdminMsg('ƒê·ªïi username c·∫ßn nh·∫≠p password m·ªõi', false);
        // create new then delete old
        addLog('REQUEST rename:create', {newUsername});
        let res = await fetch(`${API_BASE}/admin/users/create`, {
          method: 'POST',
          headers: {'content-type':'application/json', authorization:`Bearer ${token}`},
          body: JSON.stringify({ username: newUsername, password: newPassword })
        });
        let raw = await res.text();
        addLog('RESPONSE rename:create', `status ${res.status}: ${raw}`);
        if(!res.ok) return setAdminMsg('T·∫°o user m·ªõi th·∫•t b·∫°i: ' + (raw||res.status), false);
        addLog('REQUEST rename:delete', {oldUsername});
        res = await fetch(`${API_BASE}/admin/users/delete`, {
          method: 'POST', headers: {'content-type':'application/json', authorization:`Bearer ${token}`},
          body: JSON.stringify({ username: oldUsername })
        });
        raw = await res.text();
        addLog('RESPONSE rename:delete', `status ${res.status}: ${raw}`);
        if(!res.ok) return setAdminMsg('X√≥a user c≈© th·∫•t b·∫°i: ' + (raw||res.status), false);
        setAdminMsg('ƒê√£ ƒë·ªïi username', true);
        adminLoadTable();
        return;
      }
      // same username: only update password if provided
      if(!newPassword){
        setAdminMsg('Kh√¥ng c√≥ g√¨ ƒë·ªÉ l∆∞u (ch∆∞a nh·∫≠p password m·ªõi)', false);
        return;
      }
      addLog('REQUEST /admin/users/update', {newUsername});
      const res = await fetch(`${API_BASE}/admin/users/update`, {
        method: 'POST', headers: {'content-type':'application/json', authorization:`Bearer ${token}`},
        body: JSON.stringify({ username: newUsername, password: newPassword })
      });
      const raw = await res.text();
      addLog('RESPONSE /admin/users/update', `status ${res.status}: ${raw}`);
      if(res.ok){ setAdminMsg('ƒê√£ c·∫≠p nh·∫≠t m·∫≠t kh·∫©u', true); adminLoadTable(); }
      else { setAdminMsg('C·∫≠p nh·∫≠t th·∫•t b·∫°i: ' + (raw||res.status), false); }
    }catch(e){
      setAdminMsg('L·ªói: ' + e.message, false);
      addLog('ERROR adminSaveUser', e.message);
    }
  }

  // Logout all sessions
  async function adminLogoutAll(username){
    const token = getBearer();
    if(!token) return setAdminMsg('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p admin', false);
    try{
      addLog('REQUEST /admin/users/logoutAll', {username});
      const res = await fetch(`${API_BASE}/admin/users/logoutAll`, { method:'POST', headers:{'content-type':'application/json', authorization:`Bearer ${token}`}, body: JSON.stringify({ username }) });
      const raw = await res.text();
      addLog('RESPONSE /admin/users/logoutAll', `status ${res.status}: ${raw}`);
      if(res.ok){ setAdminMsg('ƒê√£ ƒëƒÉng xu·∫•t t·∫•t c·∫£ phi√™n', true); adminLoadTable(); }
      else setAdminMsg('Th·∫•t b·∫°i: ' + (raw||res.status), false);
    }catch(e){ setAdminMsg('L·ªói: ' + e.message, false); addLog('ERROR adminLogoutAll', e.message); }
  }

  // Unbind device (fingerprint)
  async function adminUnbind(username){
    const token = getBearer();
    if(!token) return setAdminMsg('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p admin', false);
    try{
      addLog('REQUEST /admin/users/unbind', {username});
      const res = await fetch(`${API_BASE}/admin/users/unbind`, { method:'POST', headers:{'content-type':'application/json', authorization:`Bearer ${token}`}, body: JSON.stringify({ username }) });
      const raw = await res.text();
      addLog('RESPONSE /admin/users/unbind', `status ${res.status}: ${raw}`);
      if(res.ok){ setAdminMsg('ƒê√£ g·ª° kh√≥a thi·∫øt b·ªã', true); adminLoadTable(); }
      else setAdminMsg('Th·∫•t b·∫°i: ' + (raw||res.status), false);
    }catch(e){ setAdminMsg('L·ªói: ' + e.message, false); addLog('ERROR adminUnbind', e.message); }
  }
  // X√≥a user
  async function adminDeleteUser(username){
    const token = getBearer();
    if(!token) return setAdminMsg('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p admin', false);
    if(!confirm(`X√≥a user "${username}"?`)) return;
    try{
      addLog('REQUEST /admin/users/delete', {username});
      const res = await fetch(`${API_BASE}/admin/users/delete`, {
        method: 'POST',
        headers: {'content-type':'application/json', authorization:`Bearer ${token}`},
        body: JSON.stringify({ username })
      });
      const raw = await res.text();
      addLog('RESPONSE /admin/users/delete', `status ${res.status}: ${raw}`);
      if(res.ok){
        setAdminMsg(`ƒê√£ x√≥a user "${username}"`, true);
        adminLoadTable();
        adminLoadPending();
      } else {
        setAdminMsg('X√≥a th·∫•t b·∫°i: ' + (raw||res.status), false);
      }
    }catch(e){
      setAdminMsg('L·ªói: ' + e.message, false);
      addLog('ERROR adminDeleteUser', e.message);
    }
  }
  </script>

  <div class="admin-header">
    <h1>üîê Admin ‚Äî Qu·∫£n l√Ω IP truy c·∫≠p</h1>
  </div>

  <div class="container">
    <div id="admin-panel" class="card">
      <h2>Qu·∫£n l√Ω Users & IPs</h2>
      <p style="margin-bottom: 20px;">Qu·∫£n l√Ω IP ƒë∆∞·ª£c ph√©p theo t·ª´ng t√†i kho·∫£n. API: <code>ymir-auth.tranlc-ymir.workers.dev</code></p>
      
      <!-- Admin controls (no token needed, uses admin session) -->
      <div class="admin-section">
        <h3 style="margin:0 0 12px 0;">T·∫°o nhanh user</h3>
        <div class="input-group">
          <input id="adm-new-username" placeholder="Username (v√≠ d·ª•: demo)">
          <input id="adm-new-password" placeholder="Password (v√≠ d·ª•: 123456)">
          <button class="btn-primary" onclick="adminAddUser()">T·∫°o user</button>
        </div>
      </div>

      

      <!-- Users Table -->
      <div class="table-wrapper">
        <table id="admin-ip-table">
          <thead>
            <tr>
              <th>Username</th>
              <th>Pass</th>
              <th>Tr·∫°ng th√°i</th>
              <th>Last login</th>
              <th>Thao t√°c</th>
            </tr>
          </thead>
          <tbody id="admin-ip-tbody">
            <tr>
              <td colspan="5" class="empty-state">Nh·∫•n "T·∫£i danh s√°ch" ƒë·ªÉ xem users</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="adm-msg" class="admin-message"></div>
    </div>

    

    <!-- Debug log -->
    <div class="card" style="margin-top:16px;">
      <h2>üõ†Ô∏è Debug</h2>
      <p style="margin:0 0 8px 0;color:#94a3b8">Ghi l·∫°i request/response ƒë·ªÉ ki·ªÉm tra v√¨ sao kh√¥ng t·∫£i ƒë∆∞·ª£c.</p>
      <pre id="debug-pre" style="white-space:pre-wrap;background:#0b1220;border:1px solid #1f2937;border-radius:8px;padding:12px;max-height:260px;overflow:auto;margin:0;"></pre>
    </div>
  </div>
</body>
</html>

