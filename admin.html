<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin â€” Quáº£n lÃ½ IP truy cáº­p</title>
  <link rel="stylesheet" href="admin.css">
</head>
<body>
  <script>
  async function sha256(t){const e=new TextEncoder().encode(t),n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n)).map(b=>b.toString(16).padStart(2,"0")).join("")}
  async function getFingerprint(){
    const d=[navigator.userAgent,navigator.language,Intl.DateTimeFormat().resolvedOptions().timeZone,
      screen.width+'x'+screen.height,screen.colorDepth,navigator.platform].join('|');
    return await sha256(d);
  }
  const AUTH_API='https://ymir-auth.tranlc-ymir.workers.dev';
  // Check authentication and redirect if needed
  async function requireAuth(){
    try{
      const fp=await getFingerprint();
      const tok=localStorage.getItem('ymir_token');
      if(!tok){
        window.location.href='login.html';
        return;
      }
      const r=await fetch(`${AUTH_API}/verify?fp=${fp}`,{headers:{authorization:`Bearer ${tok}`}}).then(x=>x.json());
      if(r&&r.ok){
        if(r.user!=='admin'){
          window.location.href='user.html';
          return;
        }
        return;
      }else{
        localStorage.removeItem('ymir_token');
        window.location.href='login.html';
      }
    }catch{
      window.location.href='login.html';
    }
  }
  requireAuth();

  // Force remove any background watermark that might remain
  try { document.addEventListener('DOMContentLoaded', function(){ document.body.style.backgroundImage = 'none'; }); } catch(_){}

  // ---- Admin panel helpers ----
  const API_BASE = AUTH_API;
  function getBearer(){ return localStorage.getItem('ymir_token') || ''; }
  // lightweight debug logger rendered on the page
  const __logs = [];
  function addLog(label, payload){
    try{
      const ts = new Date().toISOString();
      const entry = `[${ts}] ${label} ` + (payload!==undefined? (typeof payload==='string'? payload : JSON.stringify(payload)) : '');
      __logs.unshift(entry);
      const pre = document.getElementById('debug-pre');
      if(pre){ pre.textContent = __logs.slice(0,200).join("\n\n"); }
    }catch(_){ /* ignore */ }
  }
  function setAdminMsg(msg, ok){ 
    const el=document.getElementById('adm-msg'); 
    if(el){ 
      el.style.display = 'block';
      el.style.color = ok? '#10b981' : '#f87171'; 
      el.style.background = ok? 'rgba(16,185,129,0.1)' : 'rgba(248,113,113,0.1)';
      el.style.border = `1px solid ${ok? '#10b981' : '#f87171'}`;
      el.textContent = msg; 
      if(ok) setTimeout(()=>{ el.style.display = 'none'; }, 3000);
    } 
  }
  
// Load table vá»›i danh sÃ¡ch users vÃ  IPs (Æ°u tiÃªn /admin/users/all Ä‘á»ƒ láº¥y cáº£ password)
  async function adminLoadTable(){
    const token = getBearer();
    if(!token) return setAdminMsg('Báº¡n cáº§n Ä‘Äƒng nháº­p admin', false);
    try{
      addLog('REQUEST /admin/users/all');
      let res = await fetch(`${API_BASE}/admin/users/all`, { headers: { authorization: `Bearer ${token}` } });
      let text = await res.text();
      addLog('RESPONSE /admin/users/all', `status ${res.status}: ${text}`);
      let data = {};
      try{ data = JSON.parse(text); }catch(_){ data = {}; }
      if(!res.ok || !data.users){
        // fallback to older endpoint
        addLog('FALLBACK /admin/users/list');
        res = await fetch(`${API_BASE}/admin/users/list`, { headers: { authorization: `Bearer ${token}` } });
        text = await res.text();
        addLog('RESPONSE /admin/users/list', `status ${res.status}: ${text}`);
        try{ data = JSON.parse(text); }catch(_){ data = {}; }
      }
      renderAdminTable(data.users || []);
      setAdminMsg(`ÄÃ£ táº£i ${data.users?.length || 0} user(s)`, true);
    }catch(e){
      setAdminMsg('Lá»—i: ' + e.message, false);
      addLog('ERROR adminLoadTable', e.message);
    }
  }

  // Load danh sÃ¡ch IP chá» duyá»‡t
  async function adminLoadPending(){
    const token = getBearer();
    const tbody = document.getElementById('pending-tbody');
    if(!tbody) return;
    if(!token){ tbody.innerHTML = '<tr><td colspan="3" class="empty-state">Báº¡n cáº§n Ä‘Äƒng nháº­p admin</td></tr>'; return; }
    try{
      const res = await fetch(`${API_BASE}/admin/pending/list`, { headers: { authorization: `Bearer ${token}` } });
      if(!res.ok){ tbody.innerHTML = `<tr><td colspan="3" class=\"empty-state\">Lá»—i: ${res.status}</td></tr>`; return; }
      const data = await res.json();
      renderPendingTable(data.pending || []);
    }catch(e){
      const tbody2 = document.getElementById('pending-tbody');
      if(tbody2) tbody2.innerHTML = `<tr><td colspan="3" class=\"empty-state\">Lá»—i: ${e.message}</td></tr>`;
    }
  }

  function adminLoadAll(){
    adminLoadTable();
    adminLoadPending();
  }

  // Tá»± Ä‘á»™ng náº¡p token Ä‘Ã£ lÆ°u vÃ  táº£i danh sÃ¡ch khi vÃ o trang
  document.addEventListener('DOMContentLoaded', function(){ adminLoadAll(); });

// (Removed legacy admin-token handlers)
  
  // Render báº£ng admin
  function renderAdminTable(users){
    const tbody = document.getElementById('admin-ip-tbody');
    if(!tbody) return;
    if(users.length === 0){
      tbody.innerHTML = '<tr><td colspan="3" class="empty-state">ChÆ°a cÃ³ user nÃ o. ThÃªm user Ä‘á»ƒ báº¯t Ä‘áº§u quáº£n lÃ½ IP.</td></tr>';
      return;
    }
    tbody.innerHTML = users.map(u => {
      const ips = u.ips || [];
      const password = (u.password!==undefined && u.password!==null)? String(u.password) : '';
      const ipList = ips.length > 0 ? ips.map(ip => `
        <span class="ip-tag">
          ${ip}
          <button onclick="adminRemoveIpFromUser('${u.username}', '${ip}')">Ã—</button>
        </span>
      `).join('') : '<span style="color: #94a3b8;">ChÆ°a cÃ³ IP</span>';
      return `
        <tr>
          <td style="font-weight: 600;">
            <div>${u.username}</div>
            <div style="margin-top:6px;color:#94a3b8;">
              <span>Pass:</span>
              <input type="text" id="pwd-${u.username}" value="${password.replace(/"/g,'&quot;')}" placeholder="(khÃ´ng cÃ³ trong API)" style="width:180px;">
              <button onclick="adminUpdatePassword('${u.username}')">LÆ°u</button>
            </div>
          </td>
          <td>${ipList}</td>
          <td>
            <div class="ip-input-group">
              <input type="text" id="ip-input-${u.username}" placeholder="Nháº­p IP">
              <button onclick="adminAddIpToUser('${u.username}')">+ ThÃªm IP</button>
              <button onclick="adminGetMyIpForUser('${u.username}')" title="Láº¥y IP hiá»‡n táº¡i">IP</button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  function renderPendingTable(pending){
    const tbody = document.getElementById('pending-tbody');
    if(!tbody) return;
    if(!pending.length){
      tbody.innerHTML = '<tr><td colspan="3" class="empty-state">ChÆ°a cÃ³ yÃªu cáº§u duyá»‡t IP</td></tr>';
      return;
    }
    tbody.innerHTML = pending.map(item => {
      const ipTags = (item.ips||[]).map(ip => `<span class=\"ip-tag\">${ip}</span>`).join('');
      const actions = (item.ips||[]).map(ip => `<button class=\"btn-primary\" onclick=\"adminApprovePending('${item.username}','${ip}')\">Duyá»‡t ${ip}</button>`).join(' ');
      return `
        <tr>
          <td style=\"font-weight: 600;\">${item.username}</td>
          <td>${ipTags}</td>
          <td>${actions}</td>
        </tr>
      `;
    }).join('');
  }

  async function adminApprovePending(username, ip){
    const token = getBearer();
    if(!token) return setAdminMsg('Báº¡n cáº§n Ä‘Äƒng nháº­p admin', false);
    try{
      const res = await fetch(`${API_BASE}/admin/pending/approve`, {
        method: 'POST',
        headers: { 'content-type': 'application/json', authorization: `Bearer ${token}` },
        body: JSON.stringify({ username, ip })
      });
      if(res.ok){
        setAdminMsg(`ÄÃ£ duyá»‡t IP ${ip} cho ${username}`, true);
        adminLoadTable();
        adminLoadPending();
      } else {
        const t = await res.text();
        setAdminMsg('Duyá»‡t tháº¥t báº¡i: ' + (t||res.status), false);
        addLog('pending/approve failed', t||res.status);
      }
    }catch(e){
      setAdminMsg('Lá»—i: ' + e.message, false);
      addLog('ERROR adminApprovePending', e.message);
    }
  }
  
  // ThÃªm user vÃ o danh sÃ¡ch quáº£n lÃ½
  async function adminAddUser(){
    const token = getBearer();
    const username = (document.getElementById('adm-new-username').value||'').trim();
    const password = (document.getElementById('adm-new-password')?.value||'').trim();
    if(!token) return setAdminMsg('Báº¡n cáº§n Ä‘Äƒng nháº­p admin', false);
    if(!username || !password) return setAdminMsg('Nháº­p username vÃ  password', false);
    try{
      addLog('REQUEST /admin/users/create', {username});
      const res = await fetch(`${API_BASE}/admin/users/create`, { 
        method: 'POST', 
        headers: {'content-type': 'application/json', authorization: `Bearer ${token}`}, 
        body: JSON.stringify({ username, password }) 
      });
      const raw = await res.text();
      addLog('RESPONSE /admin/users/create', `status ${res.status}: ${raw}`);
      const j = (()=>{ try{return JSON.parse(raw);}catch(_){return {};}})();
      if(res.ok){
        setAdminMsg(`ÄÃ£ táº¡o user "${username}"`, true);
        document.getElementById('adm-new-username').value = '';
        if(document.getElementById('adm-new-password')) document.getElementById('adm-new-password').value = '';
        adminLoadTable();
      }else{
        setAdminMsg('Lá»—i: ' + (j.error || raw || res.status), false);
      }
    }catch(e){
      setAdminMsg('Lá»—i: ' + e.message, false);
      addLog('ERROR adminAddUser', e.message);
    }
  }
  
  // ThÃªm IP cho user
  async function adminAddIpToUser(username){
    const token = getBearer();
    const ipInput = document.getElementById(`ip-input-${username}`);
    const ip = ipInput?.value.trim();
    if(!token) return setAdminMsg('Báº¡n cáº§n Ä‘Äƒng nháº­p admin', false);
    if(!ip) return setAdminMsg('Nháº­p IP', false);
    try{
      addLog('REQUEST /admin/allowip/add', {username, ip});
      const res = await fetch(`${API_BASE}/admin/allowip/add`, { 
        method: 'POST', 
        headers: {'content-type': 'application/json', authorization: `Bearer ${token}`}, 
        body: JSON.stringify({ username, ip }) 
      });
      const raw = await res.text();
      addLog('RESPONSE /admin/allowip/add', `status ${res.status}: ${raw}`);
      const j = (()=>{ try{return JSON.parse(raw);}catch(_){return {};}})();
      if(res.ok){
        setAdminMsg(`ÄÃ£ thÃªm IP ${ip} cho ${username}`, true);
        ipInput.value = '';
        adminLoadTable();
      }else{
        setAdminMsg('Lá»—i: ' + (j.error || raw || res.status), false);
      }
    }catch(e){
      setAdminMsg('Lá»—i: ' + e.message, false);
      addLog('ERROR adminAddIpToUser', e.message);
    }
  }
  
  // XÃ³a IP cá»§a user
  async function adminRemoveIpFromUser(username, ip){
    const token = getBearer();
    if(!token) return setAdminMsg('Báº¡n cáº§n Ä‘Äƒng nháº­p admin', false);
    if(!confirm(`XÃ³a IP ${ip} cá»§a user ${username}?`)) return;
    try{
      addLog('REQUEST /admin/allowip/remove', {username, ip});
      const res = await fetch(`${API_BASE}/admin/allowip/remove`, { 
        method: 'POST', 
        headers: {'content-type': 'application/json', authorization: `Bearer ${token}`}, 
        body: JSON.stringify({ username, ip }) 
      });
      const raw = await res.text();
      addLog('RESPONSE /admin/allowip/remove', `status ${res.status}: ${raw}`);
      const j = (()=>{ try{return JSON.parse(raw);}catch(_){return {};}})();
      if(res.ok){
        setAdminMsg(`ÄÃ£ xÃ³a IP ${ip}`, true);
        adminLoadTable();
      }else{
        setAdminMsg('Lá»—i: ' + (j.error || raw || res.status), false);
      }
    }catch(e){
      setAdminMsg('Lá»—i: ' + e.message, false);
      addLog('ERROR adminRemoveIpFromUser', e.message);
    }
  }
  
  // Láº¥y IP hiá»‡n táº¡i vÃ  Ä‘iá»n vÃ o input
  async function adminGetMyIpForUser(username){
    try{
      const ip = await fetch('https://api.ipify.org').then(r=>r.text());
      const ipInput = document.getElementById(`ip-input-${username}`);
      if(ipInput) ipInput.value = ip;
      setAdminMsg(`ÄÃ£ láº¥y IP: ${ip}`, true);
      addLog('INFO my IP', ip);
    }catch{
      setAdminMsg('KhÃ´ng láº¥y Ä‘Æ°á»£c IP', false);
    }
  }

  // Update password for a user
  async function adminUpdatePassword(username){
    const token = getBearer();
    if(!token) return setAdminMsg('Báº¡n cáº§n Ä‘Äƒng nháº­p admin', false);
    const input = document.getElementById(`pwd-${username}`);
    const password = (input?.value||'').trim();
    if(!password) return setAdminMsg('Nháº­p password má»›i', false);
    try{
      addLog('REQUEST /admin/users/update', {username});
      const res = await fetch(`${API_BASE}/admin/users/update`, {
        method: 'POST',
        headers: {'content-type':'application/json', authorization:`Bearer ${token}`},
        body: JSON.stringify({ username, password })
      });
      const raw = await res.text();
      addLog('RESPONSE /admin/users/update', `status ${res.status}: ${raw}`);
      if(res.ok){ setAdminMsg('ÄÃ£ cáº­p nháº­t máº­t kháº©u', true); }
      else { setAdminMsg('Cáº­p nháº­t tháº¥t báº¡i: ' + (raw||res.status), false); }
    }catch(e){
      setAdminMsg('Lá»—i: ' + e.message, false);
      addLog('ERROR adminUpdatePassword', e.message);
    }
  }
  </script>

  <div class="admin-header">
    <h1>ğŸ” Admin â€” Quáº£n lÃ½ IP truy cáº­p</h1>
  </div>

  <div class="container">
    <div id="admin-panel" class="card">
      <h2>Quáº£n lÃ½ Users & IPs</h2>
      <p style="margin-bottom: 20px;">Quáº£n lÃ½ IP Ä‘Æ°á»£c phÃ©p theo tá»«ng tÃ i khoáº£n. API: <code>ymir-auth.tranlc-ymir.workers.dev</code></p>
      
      <!-- Admin controls (no token needed, uses admin session) -->
      <div class="admin-section">
        <h3 style="margin:0 0 12px 0;">Táº¡o nhanh user</h3>
        <div class="input-group">
          <input id="adm-new-username" placeholder="Username (vÃ­ dá»¥: demo)">
          <input id="adm-new-password" placeholder="Password (vÃ­ dá»¥: 123456)">
          <button class="btn-primary" onclick="adminAddUser()">Táº¡o user</button>
          <button class="btn-primary" onclick="adminLoadAll()">Táº£i danh sÃ¡ch</button>
        </div>
      </div>

      

      <!-- IP Management Table -->
      <div class="table-wrapper">
        <table id="admin-ip-table">
          <thead>
            <tr>
              <th>Username</th>
              <th>Danh sÃ¡ch IP</th>
              <th>Thao tÃ¡c</th>
            </tr>
          </thead>
          <tbody id="admin-ip-tbody">
            <tr>
              <td colspan="3" class="empty-state">Nháº¥n "Táº£i danh sÃ¡ch" Ä‘á»ƒ xem users vÃ  IP</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="adm-msg" class="admin-message"></div>
    </div>

    <!-- Pending IPs -->
    <div class="card" style="margin-top:16px;">
      <h2>ğŸ•‘ IP chá» duyá»‡t</h2>
      <div class="table-wrapper">
        <table id="pending-table">
          <thead>
            <tr>
              <th>Username</th>
              <th>IP chá» duyá»‡t</th>
              <th>Thao tÃ¡c</th>
            </tr>
          </thead>
          <tbody id="pending-tbody">
            <tr>
              <td colspan="3" class="empty-state">ChÆ°a cÃ³ yÃªu cáº§u duyá»‡t IP</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Debug log -->
    <div class="card" style="margin-top:16px;">
      <h2>ğŸ› ï¸ Debug</h2>
      <p style="margin:0 0 8px 0;color:#94a3b8">Ghi láº¡i request/response Ä‘á»ƒ kiá»ƒm tra vÃ¬ sao khÃ´ng táº£i Ä‘Æ°á»£c.</p>
      <pre id="debug-pre" style="white-space:pre-wrap;background:#0b1220;border:1px solid #1f2937;border-radius:8px;padding:12px;max-height:260px;overflow:auto;margin:0;"></pre>
    </div>
  </div>
</body>
</html>

